---
import Layout from '../../layouts/Layout.astro';
import Nav from '../../components/Nav.astro';
import DefinitionsJsonEndpoint from '../../components/DefinitionsJsonEndpoint.astro';
import Footer from '../../components/Footer.astro';

import catalog from '../../data/definitions-catalog.json';

const providers = (catalog.providers ?? []).map((provider) => ({
  id: provider.id,
  name: provider.name,
  modelCount: provider.model_count,
  npm: provider.npm,
  doc: provider.doc,
}));
---

<Layout title="Definitions — LLMSPEC">
  <Nav />

  <header class="w-full max-w-7xl mx-auto px-6 md:px-8 pt-40 pb-16 text-center">
    <p class="tracking-luxury text-gold-muted text-xs mb-4 font-sans reveal">THE COLLECTION</p>

    <h1 class="font-serif text-display-sm md:text-display text-cream font-light reveal">
      Definitions
    </h1>

    <p class="font-sans text-cloud/70 text-base mt-6 max-w-3xl mx-auto reveal">
      {catalog.total_models} model definitions across {catalog.total_providers} providers. Context
      limits, capabilities, pricing — machine-readable.
    </p>

    <div class="mt-8 flex flex-wrap justify-center gap-3 reveal" aria-label="Catalog stats">
      <span class="bg-slate/30 text-silver text-xs px-3 py-1.5 rounded-full border border-ash/30">
        {catalog.total_providers} providers
      </span>
      <span class="bg-slate/30 text-silver text-xs px-3 py-1.5 rounded-full border border-ash/30">
        {catalog.total_models} models
      </span>
    </div>

    <div class="gold-rule max-w-xs mx-auto mt-10 reveal"></div>
  </header>

  <main class="w-full max-w-7xl mx-auto px-6 md:px-8 pb-24">
    <div class="mb-10 reveal">
      <label class="sr-only" for="provider-filter">Filter providers</label>
      <input
        id="provider-filter"
        type="search"
        placeholder="Filter providers…"
        class="w-full rounded-lg bg-charcoal/80 border border-ash/30 px-4 py-3 font-sans text-sm text-cream placeholder:text-silver/50 outline-none focus:border-gold/40 focus:ring-2 focus:ring-gold/10 transition"
        autocomplete="off"
      />
      <p class="mt-3 font-sans text-xs text-silver/70">
        Type to filter by provider name. (Yes, there are 89. You’re welcome.)
      </p>
    </div>

    <div data-provider-sections class="w-full space-y-5">
      {providers.map((provider) => (
        <section
          class="reveal w-full"
          data-provider-wrapper
          data-provider-name={provider.name.toLowerCase()}
        >
          <div
            class="provider-accordion w-full rounded-lg border border-ash/30 bg-charcoal/50 hover:border-gold/30 transition-all duration-[400ms]"
            data-provider-item
          >
            <div class="flex items-stretch justify-between gap-4">
              <button
                type="button"
                class="provider-accordion__btn w-full px-5 py-4 text-left cursor-pointer transition-all flex items-center justify-between gap-4"
                data-provider-id={provider.id}
                aria-expanded="false"
              >
                <div class="min-w-0">
                  <div class="flex flex-wrap items-baseline gap-x-3 gap-y-2">
                    <h2 class="font-serif text-xl md:text-2xl text-cream font-light break-words">
                      {provider.name}
                    </h2>
                    <span class="bg-slate/30 text-silver text-xs px-2.5 py-1 rounded-full border border-ash/20 font-sans">
                      {provider.modelCount}
                    </span>
                  </div>

                  <div class="mt-2 flex flex-wrap items-center gap-3">
                    {provider.npm && (
                      <span class="text-silver/80 font-mono text-xs">{provider.npm}</span>
                    )}
                  </div>
                </div>

                <svg
                  class="provider-accordion__chevron h-5 w-5 shrink-0 text-silver/70 transition-transform duration-300"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-chevron
                >
                  <path
                    d="M9 18l6-6-6-6"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>

              {provider.doc && (
                <a
                  href={provider.doc}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="shrink-0 self-center pr-5 text-gold text-xs font-sans tracking-widest-plus uppercase border-b border-transparent hover:border-gold-light hover:text-gold-light transition-all duration-300"
                >
                  Docs
                </a>
              )}
            </div>

            <div
              class="provider-accordion__panel provider-panel"
              data-provider-panel={provider.id}
              aria-hidden="true"
            >
              <div class="px-5 pb-6">
                <div data-provider-models={provider.id}></div>
              </div>
            </div>
          </div>
        </section>
      ))}
    </div>

    <script is:inline>
      // Provider accordion + lazy model rendering
      let definitionsCache = null;
      let definitionsPromise = null;

      const input = document.getElementById('provider-filter');
      const wrappers = Array.from(document.querySelectorAll('[data-provider-wrapper]'));

      const matches = (haystack, needle) => {
        if (!needle) return true;
        return (haystack ?? '').toLowerCase().includes(needle);
      };

      const applyFilter = (query) => {
        wrappers.forEach((wrapper) => {
          const name = wrapper.getAttribute('data-provider-name') ?? '';
          wrapper.classList.toggle('hidden', !matches(name, query));
        });
      };

      if (input) {
        let raf = 0;
        const onInput = () => {
          const query = (input.value ?? '').trim().toLowerCase();
          if (raf) cancelAnimationFrame(raf);
          raf = requestAnimationFrame(() => applyFilter(query));
        };

        input.addEventListener('input', onInput, { passive: true });
        applyFilter('');
      }

      const escapeHtml = (value) => {
        return String(value ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      };

      const formatCompactInt = (value) => {
        const n = Number(value);
        if (!Number.isFinite(n) || n <= 0) return '—';
        if (n >= 1_000_000) {
          const m = n / 1_000_000;
          return `${m % 1 === 0 ? m.toFixed(0) : m.toFixed(1)}M`;
        }
        if (n >= 1_000) return `${Math.round(n / 1_000)}K`;
        return `${Math.round(n)}`;
      };

      const formatMoney = (value) => {
        const n = Number(value);
        if (value == null || !Number.isFinite(n)) return '—';
        return `$${n.toFixed(2)}`;
      };

      const titleCase = (value) => {
        return String(value ?? '')
          .split(/[-\s]+/)
          .filter(Boolean)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
          .join(' ');
      };

      const getStatusBadgeHtml = (status) => {
        if (!status) return '';
        const label = titleCase(status);
        const tone = String(status).toLowerCase();
        const classes = (() => {
          if (tone.includes('deprecat')) return 'bg-red-500/10 text-red-300 border-red-500/20';
          if (tone.includes('beta')) return 'bg-sky-500/10 text-sky-300 border-sky-500/20';
          if (tone.includes('alpha')) return 'bg-purple-500/10 text-purple-300 border-purple-500/20';
          return 'bg-slate/50 text-silver border-ash/20';
        })();

        return `
          <span class="shrink-0 text-[10px] px-2 py-1 rounded-full border font-sans tracking-widest-plus uppercase ${classes}">
            ${escapeHtml(label)}
          </span>
        `;
      };

      const getCapabilityPillsHtml = (model) => {
        const pills = [];

        const limit = model?.limit ?? {};
        const contextLabel = `${formatCompactInt(limit.context)} ctx`;
        const outputLabel = `${formatCompactInt(limit.output)} out`;

        pills.push(`<span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">${escapeHtml(contextLabel)}</span>`);
        pills.push(`<span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">${escapeHtml(outputLabel)}</span>`);

        if (model?.reasoning) {
          pills.push(
            '<span class="bg-emerald-500/10 text-emerald-300 text-xs px-2 py-1 rounded-full border border-emerald-500/20">Reasoning</span>',
          );
        }

        if (model?.tool_call) {
          pills.push(
            '<span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">Tool Use</span>',
          );
        }

        const inputModalities = new Set(
          (model?.modalities?.input ?? []).map((m) => String(m).toLowerCase()),
        );

        if (inputModalities.has('image')) {
          pills.push('<span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">Vision</span>');
        }
        if (inputModalities.has('audio')) {
          pills.push('<span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">Audio</span>');
        }
        if (inputModalities.has('pdf')) {
          pills.push('<span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">PDF</span>');
        }

        if (model?.open_weights) {
          pills.push(
            '<span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">Open Weights</span>',
          );
        }

        if (model?.structured_output) {
          pills.push(
            '<span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">Structured Output</span>',
          );
        }

        return pills.join('');
      };

      const getCostLineHtml = (model) => {
        const inputCost = model?.cost?.input;
        const outputCost = model?.cost?.output;
        const hasCost = inputCost != null || outputCost != null;
        if (!hasCost) return '';

        return `
          <p class="mt-4 font-sans text-sm text-cloud/70">
            <span class="font-mono text-xs text-silver/80">Cost</span>
            <span class="mx-2 text-silver/40">·</span>
            <span class="text-cream">${escapeHtml(formatMoney(inputCost))}</span>
            <span class="text-silver/60"> / </span>
            <span class="text-cream">${escapeHtml(formatMoney(outputCost))}</span>
            <span class="text-silver/70"> per M tokens</span>
          </p>
        `;
      };

      const renderModelCardHtml = (model) => {
        const name = escapeHtml(model?.name ?? model?.id ?? 'Unknown');
        const family = model?.family ? escapeHtml(model.family) : '';
        const statusBadge = getStatusBadgeHtml(model?.status);
        const pills = getCapabilityPillsHtml(model);
        const costLine = getCostLineHtml(model);
        const releaseDate = escapeHtml(model?.release_date ?? '—');

        return `
          <article class="rounded-lg border border-ash/30 bg-charcoal p-5 card-glow transition-all duration-[400ms] hover:border-gold/30 flex flex-col h-full">
            <header class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <h3 class="font-serif text-lg text-cream font-medium break-words leading-snug">${name}</h3>
                ${family ? `<p class="mt-1 font-sans text-[11px] text-silver/80 tracking-widest-plus uppercase">${family}</p>` : ''}
              </div>
              ${statusBadge}
            </header>

            <div class="mt-3 flex flex-wrap gap-1.5">${pills}</div>

            ${costLine}

            <footer class="mt-auto pt-4">
              <span class="font-mono text-[11px] text-silver/60">Released ${releaseDate}</span>
            </footer>
          </article>
        `;
      };

      const renderProviderModels = async (providerId) => {
        const container = document.querySelector(`[data-provider-models="${CSS.escape(providerId)}"]`);
        if (!container) return;
        if (container.getAttribute('data-rendered') === 'true') return;

        container.innerHTML = `
          <div class="py-12 text-center">
            <p class="text-silver/60 font-sans text-sm animate-pulse">Loading models…</p>
          </div>
        `;

        try {
          if (!definitionsCache) {
            if (!definitionsPromise) {
              definitionsPromise = fetch('/definitions/definitions.json', { credentials: 'same-origin' })
                .then((res) => {
                  if (!res.ok) throw new Error(`Failed to fetch definitions.json (${res.status})`);
                  return res.json();
                })
                .then((json) => {
                  definitionsCache = json;
                  return json;
                });
            }

            await definitionsPromise;
          }

          const provider = (definitionsCache?.providers ?? []).find((p) => p?.id === providerId);
          const models = provider?.models ?? [];

          const gridHtml = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 items-stretch">
              ${models.map(renderModelCardHtml).join('')}
            </div>
          `;

          container.innerHTML = gridHtml;
          container.setAttribute('data-rendered', 'true');
        } catch (err) {
          container.innerHTML = `
            <div class="py-12 text-center">
              <p class="text-silver/60 font-sans text-sm">Failed to load models.</p>
            </div>
          `;
          // eslint-disable-next-line no-console
          console.error(err);
        }
      };

      const setExpanded = async (providerId, expanded) => {
        const wrapper = document
          .querySelector(`[data-provider-panel="${CSS.escape(providerId)}"]`)
          ?.closest('[data-provider-item]');
        const button = document.querySelector(`[data-provider-id="${CSS.escape(providerId)}"]`);
        const panel = document.querySelector(`[data-provider-panel="${CSS.escape(providerId)}"]`);

        if (!wrapper || !button || !panel) return;

        wrapper.classList.toggle('is-open', expanded);
        button.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        panel.setAttribute('aria-hidden', expanded ? 'false' : 'true');

        if (expanded) {
          await renderProviderModels(providerId);
          panel.style.maxHeight = `${panel.scrollHeight}px`;
        } else {
          panel.style.maxHeight = '0px';
        }
      };

      const toggleProvider = async (providerId) => {
        const button = document.querySelector(`[data-provider-id="${CSS.escape(providerId)}"]`);
        if (!button) return;
        const expanded = button.getAttribute('aria-expanded') === 'true';
        await setExpanded(providerId, !expanded);
      };

      const providerButtons = Array.from(document.querySelectorAll('[data-provider-id]'));
      providerButtons.forEach((btn) => {
        btn.addEventListener('click', async () => {
          const providerId = btn.getAttribute('data-provider-id');
          if (!providerId) return;
          await toggleProvider(providerId);
        });
      });

      // Keep panel max-heights sane on resize.
      window.addEventListener(
        'resize',
        () => {
          document.querySelectorAll('.provider-accordion.is-open .provider-panel').forEach((panel) => {
            panel.style.maxHeight = `${panel.scrollHeight}px`;
          });
        },
        { passive: true },
      );
    </script>

<style>
  .provider-accordion {
    border-left: 3px solid transparent;
  }

  .provider-accordion.is-open {
    border-left-color: rgba(191, 151, 77, 0.9);
    border-left-width: 3px;
  }

  .provider-accordion__btn {
    border-radius: 0.5rem;
  }

  .provider-accordion.is-open [data-chevron] {
    transform: rotate(90deg);
  }

  .provider-panel {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition:
      max-height 420ms ease,
      opacity 240ms ease;
  }

  .provider-accordion.is-open .provider-panel {
    opacity: 1;
  }
</style>
  </main>

  <DefinitionsJsonEndpoint />

  <Footer />

  <!-- Tailwind safelist: classes used in client-side rendered model cards -->
  <div
    class="hidden
      bg-emerald-500/10 text-emerald-300 border-emerald-500/20
      bg-gold-muted/10 text-gold-muted border-gold-muted/20
      bg-slate/50 text-silver border-ash/20
      bg-red-500/10 text-red-300 border-red-500/20
      bg-sky-500/10 text-sky-300 border-sky-500/20
      bg-purple-500/10 text-purple-300 border-purple-500/20
      bg-charcoal text-cream text-cloud/70 text-silver/80 text-silver/60 text-silver/70 text-silver/40
      font-serif font-mono font-sans
      rounded-lg border card-glow
      items-stretch
    "
    aria-hidden="true"
  ></div>
</Layout>
