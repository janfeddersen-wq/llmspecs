---
interface Props {
  id: string;
  name: string;
  family?: string;
  provider: string;
  releaseDate: string;
  reasoning: boolean;
  toolCall: boolean;
  attachment: boolean;
  openWeights: boolean;
  structuredOutput?: boolean;
  temperature?: boolean;
  knowledge?: string;
  status?: string;
  modalities: { input: string[]; output: string[] };
  limit: { context: number; output: number; input?: number };
  cost?: { input?: number; output?: number };
}

const {
  name,
  family,
  releaseDate,
  reasoning,
  toolCall,
  openWeights,
  structuredOutput,
  status,
  modalities,
  limit,
  cost,
} = Astro.props;

function formatCompactInt(value: number): string {
  if (!Number.isFinite(value) || value <= 0) return '—';

  if (value >= 1_000_000) {
    const m = value / 1_000_000;
    return `${m % 1 === 0 ? m.toFixed(0) : m.toFixed(1)}M`;
  }

  if (value >= 1_000) {
    return `${Math.round(value / 1_000)}K`;
  }

  return `${Math.round(value)}`;
}

function formatMoney(value?: number): string {
  if (value == null || !Number.isFinite(value)) return '—';
  return `$${value.toFixed(2)}`;
}

function titleCase(value: string): string {
  return value
    .split(/[-\s]+/)
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
    .join(' ');
}

const contextLabel = `${formatCompactInt(limit?.context)} ctx`;
const outputLabel = `${formatCompactInt(limit?.output)} out`;

const inputCost = cost?.input;
const outputCost = cost?.output;
const hasCost = inputCost != null || outputCost != null;

const inputModalities = new Set((modalities?.input ?? []).map((m) => m.toLowerCase()));

const statusLabel = status ? titleCase(status) : undefined;
const statusTone = (status ?? '').toLowerCase();

const statusClasses = (() => {
  if (!statusLabel) return '';
  if (statusTone.includes('deprecat')) return 'bg-red-500/10 text-red-300 border-red-500/20';
  if (statusTone.includes('beta')) return 'bg-sky-500/10 text-sky-300 border-sky-500/20';
  if (statusTone.includes('alpha')) return 'bg-purple-500/10 text-purple-300 border-purple-500/20';
  return 'bg-slate/50 text-silver border-ash/20';
})();
---

<article
  class="rounded-lg border border-ash/30 bg-charcoal p-5 md:p-6 card-glow transition-all duration-[400ms] ease-[ease] hover:border-gold/30"
>
  <header class="flex items-start justify-between gap-4">
    <div class="min-w-0">
      <h3 class="font-serif text-xl text-cream font-medium break-words">
        {name}
      </h3>

      {family && (
        <p class="mt-1 font-sans text-xs text-silver/90 tracking-widest-plus uppercase">
          {family}
        </p>
      )}
    </div>

    {statusLabel && (
      <span class={`shrink-0 text-[10px] px-2 py-1 rounded-full border font-sans tracking-widest-plus uppercase ${statusClasses}`}>
        {statusLabel}
      </span>
    )}
  </header>

  <div class="mt-4 flex flex-wrap gap-2">
    <span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">
      {contextLabel}
    </span>
    <span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">
      {outputLabel}
    </span>

    {reasoning && (
      <span class="bg-emerald-500/10 text-emerald-300 text-xs px-2 py-1 rounded-full border border-emerald-500/20">
        Reasoning
      </span>
    )}

    {toolCall && (
      <span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">
        Tool Use
      </span>
    )}

    {inputModalities.has('image') && (
      <span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">
        Vision
      </span>
    )}

    {inputModalities.has('audio') && (
      <span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">
        Audio
      </span>
    )}

    {inputModalities.has('pdf') && (
      <span class="bg-slate/50 text-silver text-xs px-2 py-1 rounded-full border border-ash/20">
        PDF
      </span>
    )}

    {openWeights && (
      <span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">
        Open Weights
      </span>
    )}

    {structuredOutput && (
      <span class="bg-gold-muted/10 text-gold-muted text-xs px-2 py-1 rounded-full border border-gold-muted/20">
        Structured Output
      </span>
    )}
  </div>

  {hasCost && (
    <p class="mt-4 font-sans text-sm text-cloud/70">
      <span class="font-mono text-xs text-silver/80">Cost</span>
      <span class="mx-2 text-silver/40">·</span>
      <span class="text-cream">
        {formatMoney(inputCost)}
      </span>
      <span class="text-silver/60"> / </span>
      <span class="text-cream">
        {formatMoney(outputCost)}
      </span>
      <span class="text-silver/70"> per M tokens</span>
    </p>
  )}

  <footer class="mt-5 flex items-center justify-between gap-4">
    <span class="font-mono text-[11px] text-silver/70">Released {releaseDate}</span>
    <span class="font-mono text-[11px] text-silver/50">{contextLabel}</span>
  </footer>
</article>
